# Repository Guidelines

This document orients contributors to Real Staging AI's codebase and workflows. Keep changes small, tested, and clearly documented.

## Project Structure & Module Organization
- `apps/api`: Go HTTP API (Echo), domain packages under `internal/<domain>` (e.g., `internal/project`, `internal/image`, `internal/http`). Integration tests live in `apps/api/tests/integration`.
- `apps/worker`: Go background worker that processes image jobs.
- `infra/migrations`: SQL schema migrations (up/down files).
- `web/api/v1`: OpenAPI spec (`oas3.yaml`) and docs.
- `docs`: Architecture, configuration, and developer guides.

## Build, Test, and Development Commands
- `make up` / `make down`: Start/stop dev stack (API, worker, DB, etc.) via Docker Compose.
- `make test` / `make test-cover`: Run unit tests (per module) with optional coverage HTML.
- `make test-integration`: Bring up dockerized deps and run integration tests.
- `make lint` / `make lint-fix`: Run golangci-lint (in Docker) and optionally apply fixes.
- `make generate`: Run code generation (sqlc, mocks via `go generate`).
- Mock generation (moq): define an interface (e.g., in `service.go`) and add `//go:generate go run github.com/matryer/moq@v0.5.3 -out <file> . <Interface>`. Provide the concrete implementation in a matching `default_*.go` file.
- `make migrate`, `make migrate-*(up|down)`: Apply migrations to dev or test DBs.
- `make token`: Print an Auth0 access token for local testing.
- all database mocking will be done using `storage.DatabaseMock`, `storage.PgxPoolMock`, and github.com/pashagolub/pgxmock/v2

## Coding Style & Naming Conventions
- Language: Go 1.22+; format with `gofmt` and lint with `golangci-lint`. Provide Godoc comments and follow idiomatic Go practices.
- Packages: lower-case, short names; place domain logic in `internal/<domain>`. When an internal package name conflicts with a standard/public package, alias the internal package as `<package>Lib` (e.g., `import ("net/http"; httpLib "github.com/real-staging-ai/api/internal/http")`).
- Files: tests end with `*_test.go`; mocks end with `_mock.go` (auto-generated). Define interfaces in files like `service.go` and pair concrete implementations in `default_*.go`.
- SQL-to-Go: generated by `sqlc` per `apps/api/sqlc.yaml`.

## Testing Guidelines
- Framework: standard `go test` with tags. Unit tests live alongside code; integration tests in `apps/api/tests/integration`.
- Commands: `make test` (fast), `make test-integration` (dockerized Postgres/Redis/S3), `make test-cover` (coverage report).
- Conventions: functions `TestXxx(t *testing.T)`; use table-driven tests; test names begin with `success: ` or `fail: ` and always include a happy path; prefer `t.Setenv()` over `os.Setenv()`; keep external calls mocked except in integration suites.

## Pre-Commit Workflow
Before committing any changes, **always** run the following commands in order and ensure all pass:
1. `make generate` - Regenerate code (sqlc, mocks)
2. `make lint` - Verify code style (0 issues required)
3. `make test` - Run unit tests (all must pass)
4. `make test-integration` - Run integration tests (all must pass)

This workflow ensures code quality, prevents broken builds, and catches issues early. **Do not commit if any of these steps fail.**

## Commit & Pull Request Guidelines
- Commits: follow Conventional Commits (e.g., `feat(api): add presign upload endpoint`).
- We use Conventional Commits for all changes. Format: `type(scope): subject`.
  - Common types: `feat`, `fix`, `docs`, `chore`, `refactor`, `test`, `perf`.
  - Example scopes: `api`, `worker`, `infra`, `docs`, `db`, `stripe`.
  - Reference: https://www.conventionalcommits.org/
- PRs: include purpose, linked issues, test plan/output, and screenshots/logs when relevant. Ensure `make test` and `make lint` pass. Touch docs when changing behavior (see `docs/`).

## Security & Configuration Tips
- Do not commit secrets. Use `.env` for local values loaded by Docker Compose. See `docs/configuration.md`.
- S3/Stripe/Auth0 configs are required to run end-to-end; for local testing, the stack uses test containers and LocalStack/MinIO where applicable.
