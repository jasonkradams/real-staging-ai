# Project Review and Next Steps — 2025-09-26

This entry records completion of end-to-end SSE broadcasting and image status updates for Phase 1. With Redis/asynq wired, the worker now updates the database on state transitions and publishes status updates that the API streams over SSE. Integration tests and unit tests are passing.

## 1) Summary: What Landed Since 2025-09-25

- Queue + Worker (Asynq) remained in place from 2025-09-25.
- Image status updates (P0) are complete and idempotent:
  - `processing` when work starts
  - `ready` with `staged_url` on success
  - `error` with error message on failure
- SSE broadcasting (P0) is complete end-to-end:
  - Worker publishes `processing`/`ready`/`error` to Redis per image.
  - API SSE endpoint subscribes and streams events with initial `connected` and heartbeat support.
  - Integration test covers processing → ready and processing → error flows.
- Test infra updates:
  - Integration tests run with dockerized Postgres/Redis/LocalStack.
  - `Makefile` sets the correct PG* and `REDIS_ADDR` for API and worker integration tests.

## 2) Current P0 Status

- Job Queue: DONE (2025-09-25).
- Image Status Updates: DONE (2025-09-26).
- SSE Broadcasting: DONE (2025-09-26).
- Stripe hardening: in good shape; production enforcement of `STRIPE_WEBHOOK_SECRET` exists (fail-fast in non-dev), with signature verification and idempotency scaffolding in place. Unit tests cover key cases.

## 3) How to Verify Locally

- `make up` (API, Worker, Postgres, Redis, MinIO)
- Create project → presign → PUT an image to MinIO → create image (original_url pointing to object).
- Connect to `GET /api/v1/events?image_id=...` and observe:
  - `connected` → `processing` → `ready` (or `error`)
- Confirm DB `images` row updates accordingly (status and staged_url on success).

## 4) Next Steps

- Stripe (P0 wrap-up)
  - Keep unit tests comprehensive for field mapping and idempotency paths.
  - Ensure production env has `STRIPE_WEBHOOK_SECRET` set; docs updated accordingly.
- E2E (P1):
  - Add presign → upload (MinIO) → create image → wait-for-ready flow as a dockerized integration test.
- Docs & CI (P1):
  - Publish API docs (GitHub Pages) and ensure CI validates spec via `make docs`.
- Observability (P2):
  - Additional spans and structured logs around enqueue/process/update/publish paths.

## 6) Docs Publishing

- GitHub Pages workflow added: `.github/workflows/pages.yml`.
- On push to `main`, the job validates OpenAPI via `make docs`, uploads `apps/api/web/api/v1/` as the site artifact, and deploys with `actions/deploy-pages`.
- Enable in repo settings: Settings → Pages → Build and deployment → Source: GitHub Actions.

## 5) Acceptance Snapshot (Phase 1 P0)

- Creating an image enqueues a job and results in:
  - DB job metadata persisted,
  - Worker consumption and DB status updates,
  - SSE stream reflecting status changes for the image.

