# Project Review and Next Steps — 2025-09-29

Date: 2025-09-29

## 1) Executive Summary

- **Phase 1 P0 is complete end-to-end**: queue + worker (asynq), idempotent image status updates, SSE broadcasting, and Stripe webhook hardening are in place.
- **System is ready for P1 polish and frontend bootstrap**. Focus shifts to E2E testing, storage reconciliation, documentation polish, and Next.js app scaffolding.

References: `docs/review/2025-09-26-analysis.md`, `docs/review/2025-09-29-stripe-hardening.md`, `docs/todo/TODOS.md`.

## 2) Since the last reviews

- **Stripe hardening completed** (security, idempotency, mapping, unit tests, prod secret enforcement) — see `docs/review/2025-09-29-stripe-hardening.md`.
- **SSE broadcasting completed** and image status updates are idempotent — see `docs/review/2025-09-26-analysis.md`.
- **Redis/asynq integration** landed earlier — see `docs/review/2025-09-25-analysis.md`.

## 3) Current State (Backend)

- **API (`apps/api`)**
  - Auth0 JWT in prod; test server bypass with `X-Test-User`.
  - Projects, uploads (presign), images, SSE endpoint, Stripe webhook, and billing endpoints implemented.
  - OpenAPI served at `/api/v1/docs`; Pages workflow present at `.github/workflows/pages.yml`.
- **Worker (`apps/worker`)**
  - Uses Redis/asynq; updates `images` table on start/success/failure; idempotent transitions.
  - Publishes status updates consumed by API SSE; structured logging with OTEL correlation.
- **Billing (Stripe)**
  - Signature verification with tolerance; fail-fast secret enforcement outside dev.
  - Idempotency via `processed_events`; subscriptions and invoices persisted; list endpoints available.
- **Tests**
  - Unit/integration tests across API/worker; SSE integration tests passing.
  - Stripe tests are comprehensive; add full E2E flow (see P1 tasks).
- **Docs**
  - Strong coverage across `docs/*` and `web/api/v1/oas3.yaml` validated by `make docs`.
  - GitHub Pages is live: https://jasonkradams.github.io/virtual-staging-ai/

## 4) Open Items (Prioritized)

- **P1 — E2E Integration Test**
  - Dockerized flow: presign → upload (MinIO) → create image → worker runs → image becomes `ready` → SSE reflects updates.
- **P1 — Storage Reconciliation (MinIO vs DB)**
  - Implement module and admin endpoint/CLI as outlined in `docs/todo/TODOS.md` §3.8 (`apps/api/internal/reconcile`, admin `POST /api/v1/admin/reconcile/images`, and CLI under `apps/api/cmd/reconcile`).
- **P1 — Docs & CI**
  - Pages is live (https://jasonkradams.github.io/virtual-staging-ai/); add docs link in repo description; finish OTEL guide (`docs/roadmap/phase1/OBSERVABILITY.md`).
  - CI matrix for api/worker; optional integration tests nightly or via label.
- **P1 — Frontend Bootstrap (Next.js)**
  - Scaffold `apps/web`, Auth0 login, basic pages (Dashboard, Projects, Upload, Images with SSE client), and billing screens.
- **P2 — Observability polish**
  - Additional spans and structured logs around enqueue/process/update/publish paths.
- **P2 — Security polish**
  - Document `STRIPE_WEBHOOK_SECRET` rotation (noted), review route auth scopes.

## 5) Short-Term Plan (1–2 Weeks)

- **Week 1**
  - Add E2E integration test (dockerized; env-gated for CI).
  - Finalize OTEL documentation and collector config guide.
  - Enable GitHub Pages in repo settings; add docs link to repo description.
  - CI: introduce lint/test matrix for api/worker; toggle for integration tests.
- **Week 2**
  - Build Storage Reconciliation MVP: CLI with `--dry-run` and summaries; idempotent updates.
  - Add admin endpoint (role-gated) behind `RECONCILE_ENABLED`.
  - Bootstrap Next.js app with Auth0 login and Projects list; wire Images + SSE after.

## 6) Risks & Mitigations

- **Environment drift (Redis/MinIO/OTEL)**
  - Mitigation: keep `make up` profile authoritative; `.env` examples; troubleshooting notes.
- **S3 ↔ DB skew until reconciliation lands**
  - Mitigation: build reconcilers with dry-run; idempotent writes; metrics and logs.
- **Webhook misconfiguration in production**
  - Mitigation: fail-fast secret enforcement, alarm on signature failures; rotation doc.
- **Queue load/backpressure**
  - Mitigation: tune `WORKER_CONCURRENCY`, queue names, retries; consider asynqmon later.

## 7) Acceptance Checklist (Rolling)

- **P0 (done)**
  - Redis/asynq queue; idempotent image updates; SSE streaming; Stripe hardened with tests.
- **P1**
  - E2E flow test (dev + CI).
  - Reconciliation CLI (dry-run + summary) and admin endpoint.
  - Docs: OTEL guide; Pages enabled + repo link; CI matrix and optional nightly integrations.
  - Frontend scaffold with Auth0 and core pages.
- **P2**
  - Observability polish (extra spans/metrics); security scope review.

## 8) How to Verify Now (P0)

- `make up` to start API, worker, Postgres, Redis, MinIO.
- Create project → presign → PUT object → create image.
- Connect to `GET /api/v1/events?image_id=...` and observe `connected` → `processing` → `ready` or `error`.
- Confirm `images.status=ready` and `images.staged_url` set on success.

## 9) Quick Links

- Roadmap: `docs/roadmap/README.md`
- Todos & Checklists: `docs/todo/TODOS.md`, `docs/todo/P1_CHECKLIST.md`
- Recent reviews: `docs/review/2025-09-26-analysis.md`, `docs/review/2025-09-29-stripe-hardening.md`
